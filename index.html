<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工资计算系统</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 00.5px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            padding: 10px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .form-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #ffffff;
            color: #2c3e50;
        }
        input:focus, select:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        button {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .calendar-container {
            margin: 30px 0;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #3498db;
            color: white;
        }
        .calendar-nav-button {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            min-width: 60px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        .calendar-nav-button:hover {
            background-color: #1c6ea4;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #bdc3c7;
        }
        .calendar-day-header {
            background-color: #ecf0f1;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }
        .calendar-day {
            height: 60px;
            background-color: white;
            padding: 5px;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s;
            color: #2c3e50;
        }
        .calendar-day:hover {
            background-color: #f0f8ff;
            transform: scale(1.05);
            z-index: 1;
        }
        .calendar-day.selected-rest {
            background-color: #ffcdd2;
        }
        .calendar-day.selected-paid {
            background-color: #c8e6c9;
        }
        .calendar-day.working {
            background-color: #e3f2fd;
        }
        .calendar-day.weekend {
            background-color: #fff3e0;
        }
        .calendar-day.other-month {
            background-color: #f5f5f5;
            color: #95a5a6;
        }
        .calendar-day-number {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
        }
        .calendar-day-type {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
        }
        .rest-indicator {
            background-color: #f44336;
            color: white;
        }
        .paid-indicator {
            background-color: #4caf50;
            color: white;
        }
        .working-indicator {
            background-color: #2196f3;
            color: white;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
        }
        .rest-legend {
            background-color: #ffcdd2;
        }
        .paid-legend {
            background-color: #c8e6c9;
        }
        .weekend-legend {
            background-color: #fff3e0;
        }
        .working-legend {
            background-color: #e3f2fd;
        }
        .collapsible {
            background-color: #ecf0f1;
            color: #2c3e50;
            cursor: pointer;
            padding: 12px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .collapsible:hover {
            background-color: #d5dbdb;
        }
        .content {
            padding: 0 18px;
            display: none;
            overflow: hidden;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .active, .collapsible.active {
            background-color: #ffffff;
            color: #2c3e50;
        }
        .content.show {
            display: block;
        }
        .results {
            margin-top: 30px;
            border-top: 2px solid #ecf0f1;
            padding-top: 20px;
        }
        .summary-card {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            color: #2c3e50;
        }
        .summary-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            color: #2c3e50;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .total-salary {
            font-size: 28px;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            color: #2c3e50;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #bdc3c7;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            color: #2c3e50;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            border: 1px solid #bdc3c7;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #ecf0f1;
            color: #2c3e50;
            font-weight: bold;
        }
        td {
            background-color: white;
            color: #2c3e50;
        }
        .increment-buttons {
            display: flex;
            gap: 5px;
            margin-top: 5px;
        }
        .increment-btn {
            flex: 1;
            padding: 5px;
            font-size: 12px;
            background-color: #95a5a6;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .increment-btn:hover {
            background-color: #7f8c8d;
        }
        @media (max-width: 768px) {
            .form-section {
                grid-template-columns: 1fr;
            }
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
            }
            .calendar-day {
                height: 50px;
                font-size: 12px;
            }
        }
        
        /* 自动关闭通知样式 */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: #4CAF50;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease-in-out;
            font-size: 16px;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>工资计算系统</h1>
        
        <div class="form-section">
            <div class="form-group">
                <label for="year">年份:</label>
                <select id="year" onchange="updateCalendar()"></select>
            </div>
            
            <div class="form-group">
                <label for="month">月份:</label>
                <select id="month" onchange="updateCalendar()"></select>
            </div>
        </div>
        
        <button class="collapsible">工资参数设置</button>
        <div class="content">
            <div class="form-section">
                <div class="form-group">
                    <label for="hourlyRate">时薪 (元/小时):</label>
                    <input type="number" id="hourlyRate" step="0.01" value="10.4" oninput="debouncedCalculate()">
                </div>
                
                <div class="form-group">
                    <label for="performanceRate">绩效费率 (元/小时):</label>
                    <input type="number" id="performanceRate" step="0.01" value="3.2" oninput="debouncedCalculate()">
                </div>
                
                <div class="form-group">
                    <label for="efficiencyFactor">效率系数:</label>
                    <input type="number" id="efficiencyFactor" step="0.001" value="0.504" oninput="debouncedCalculate()">
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-group">
                    <label for="weekdayNightFee">工作日夜班费 (元/天):</label>
                    <input type="number" id="weekdayNightFee" value="30" oninput="debouncedCalculate()">
                </div>
                
                <div class="form-group">
                    <label for="weekendNightFee">周日夜班费 (元/天):</label>
                    <input type="number" id="weekendNightFee" value="10" oninput="debouncedCalculate()">
                </div>
                
                <div class="form-group">
                    <label for="paidLeaveRate">有薪假期费率 (元/天):</label>
                    <input type="number" id="paidLeaveRate" value="83.2" oninput="debouncedCalculate()">
                </div>
            </div>
        </div>
        
        <button class="collapsible">请假时间设置</button>
        <div class="content">
            <div class="form-section">
                <div class="form-group">
                    <label for="singleTimeLeave">单倍时间请假 (小时):</label>
                    <input type="number" id="singleTimeLeave" value="0" step="0.5" oninput="debouncedCalculate()">
                    <div class="increment-buttons">
                        <button class="increment-btn" onclick="adjustValue('singleTimeLeave', -0.5)">-0.5</button>
                        <button class="increment-btn" onclick="adjustValue('singleTimeLeave', 0.5)">+0.5</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="overtime15Leave">1.5倍时间请假 (小时):</label>
                    <input type="number" id="overtime15Leave" value="0" step="0.5" oninput="debouncedCalculate()">
                    <div class="increment-buttons">
                        <button class="increment-btn" onclick="adjustValue('overtime15Leave', -0.5)">-0.5</button>
                        <button class="increment-btn" onclick="adjustValue('overtime15Leave', 0.5)">+0.5</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="doubleTimeLeave">双倍时间请假 (小时):</label>
                    <input type="number" id="doubleTimeLeave" value="0" step="0.5" oninput="debouncedCalculate()">
                    <div class="increment-buttons">
                        <button class="increment-btn" onclick="adjustValue('doubleTimeLeave', -0.5)">-0.5</button>
                        <button class="increment-btn" onclick="adjustValue('doubleTimeLeave', 0.5)">+0.5</button>
                    </div>
                </div>
            </div>
        </div>

        <button class="collapsible">批量计算多月工资</button>
        <div class="content">
            <div class="form-section">
                <div class="form-group">
                    <label>起始年月:</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="startYear" style="flex:1;"></select>
                        <select id="startMonth" style="flex:1;"></select>
                    </div>
                </div>

                <div class="form-group">
                    <label>结束年月:</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="endYear" style="flex:1;"></select>
                        <select id="endMonth" style="flex:1;"></select>
                    </div>
                </div>
            </div>
            <button onclick="calculateMultipleMonths()" style="background-color:#2ecc71;">批量计算工资</button>
            
            <div style="margin-top:15px; display:flex; gap:10px;">
                <button onclick="exportWorkStatus()" style="flex:1; background-color:#9b59b6; color:white;">导出工作状态</button>
                <button onclick="document.getElementById('importFile').click()" style="flex:1; background-color:#e67e22; color:white;">导入工作状态</button>
                <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importWorkStatus(event)">
            </div>
        </div>

        <div id="batchResults" class="results" style="display:none; margin-top:30px;">
            <h2 style="text-align:center; color:#2c3e50;">多月工资汇总</h2>
            <table id="batchTable">
                <thead>
                    <tr>
                        <th>年月</th>
                        <th>基本工资</th>
                        <th>加班工资</th>
                        <th>绩效奖金</th>
                        <th>效率奖金</th>
                        <th>夜班费</th>
                        <th>有薪假期</th>
                        <th>总工资</th>
                    </tr>
                </thead>
                <tbody id="batchTableBody"></tbody>
            </table>
            <div style="text-align:center; margin-top:15px;">
                <button onclick="exportBatchToCSV()">导出为 CSV</button>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color working-legend"></div>
                <span>工作日</span>
            </div>
            <div class="legend-item">
                <div class="legend-color rest-legend"></div>
                <span>休息日</span>
            </div>
            <div class="legend-item">
                <div class="legend-color paid-legend"></div>
                <span>有薪假期</span>
            </div>
            <div class="legend-item">
                <div class="legend-color weekend-legend"></div>
                <span>周末</span>
            </div>
        </div>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <div style="flex: 1; text-align: left;">
                    <button class="calendar-nav-button" onclick="changeMonth(-1)">
                        <span>‹</span>
                        <span style="margin-left: 3px; font-size: 12px;">上月</span>
                    </button>
                </div>
                <h2 id="currentMonthYear" style="margin: 0; font-size: 1.4em; text-align: center; flex: 2;">2023年10月</h2>
                <div style="flex: 1; text-align: right;">
                    <button class="calendar-nav-button" onclick="changeMonth(1)">
                        <span style="font-size: 12px;">下月</span>
                        <span style="margin-left: 3px;">›</span>
                    </button>
                </div>
            </div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
        
        <div class="results" id="results" style="display:block;">
            <div class="tabs">
                <div class="tab active" onclick="showTab('summary')">摘要</div>
                <div class="tab" onclick="showTab('details')">详细信息</div>
                <div class="tab" onclick="showTab('breakdown')">工资构成</div>
            </div>
            
            <div id="summary" class="tab-content active">
                <div class="summary-card">
                    <div class="summary-title">工资摘要</div>
                    <div class="summary-item"><span>基本工资:</span> <span id="basicSalary">0.00元</span></div>
                    <div class="summary-item"><span>加班工资:</span> <span id="overtimeSalary">0.00元</span></div>
                    <div class="summary-item"><span>绩效奖金:</span> <span id="performanceBonus">0.00元</span></div>
                    <div class="summary-item"><span>效率奖金:</span> <span id="efficiencyBonus">0.00元</span></div>
                    <div class="summary-item"><span>夜班费:</span> <span id="nightShiftFee">0.00元</span></div>
                    <div class="summary-item"><span>有薪假期工资:</span> <span id="paidLeaveSalary">0.00元</span></div>
                </div>
                
                <div class="total-salary">
                    总工资: <span id="totalSalary">0.00</span> 元
                </div>
            </div>
            
            <div id="details" class="tab-content">
                <div class="summary-card">
                    <div class="summary-title">详细信息</div>
                    <div class="summary-item"><span>年月</span> <span id="yearMonth"></span></div>
                    <div class="summary-item"><span>应上班天数</span> <span id="shouldWorkDays"></span></div>
                    <div class="summary-item"><span>应上班时长</span> <span id="shouldWorkHours"></span></div>
                    <div class="summary-item"><span>实际总工时</span> <span id="actualTotalHours"></span></div>
                    <div class="summary-item"><span>实际单倍工时</span> <span id="actualSingleHours"></span></div>
                    <div class="summary-item"><span>实际1.5倍加班</span> <span id="actualOvertime15"></span></div>
                    <div class="summary-item"><span>实际周日工时</span> <span id="actualSundayHours"></span></div>
                    <div class="summary-item"><span>实际周六工时</span> <span id="actualSaturdayHours"></span></div>
                    <div class="summary-item"><span>休息日数量</span> <span id="restDaysCount"></span></div>
                    <div class="summary-item"><span>有薪假期数量</span> <span id="paidLeaveCount"></span></div>
                    <div class="summary-item"><span>工作日休息天数</span> <span id="weekdayRestDays"></span></div>
                    <div class="summary-item"><span>周末上班天数</span> <span id="weekendWorkDays"></span></div>
                    <div class="summary-item"><span>情况类型</span> <span id="caseType"></span></div>
                </div>
            </div>
            
            <div id="breakdown" class="tab-content">
                <div class="summary-card">
                    <div class="summary-title">工资构成</div>
                    <div class="summary-item">
                        <span>单倍工资 (1.0x)</span>
                        <span id="singlePayAmount">0.00元</span>
                    </div>
                    <div class="summary-item">
                        <span>1.5倍加班 (1.5x)</span>
                        <span id="overtime15PayAmount">0.00元</span>
                    </div>
                    <div class="summary-item">
                        <span>双倍加班 (2.0x)</span>
                        <span id="doublePayAmount">0.00元</span>
                    </div>
                    <div class="summary-item">
                        <span>合计</span>
                        <span id="breakdownTotal">0.00元</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 自动关闭通知 -->
    <div id="notification" class="notification">工作状态导入成功！</div>

    <script>
        // 存储日历数据（按年月索引）
        var calendarData = {};
        var currentYear = new Date().getFullYear();
        var currentMonth = new Date().getMonth() + 1;
        var debounceTimer = null;

        // 初始化下拉框选项
        function initializeSelectOptions() {
            var currentYearGlobal = new Date().getFullYear();
            var yearSelectIds = ['year', 'startYear', 'endYear'];
            var monthSelectIds = ['month', 'startMonth', 'endMonth'];
            var monthNames = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
            
            // 初始化年份选项
            yearSelectIds.forEach(function(id) {
                var select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '';
                    for (var i = 2020; i <= 2050; i++) {
                        var option = document.createElement('option');
                        option.value = i;
                        option.text = i;
                        if (i === currentYearGlobal) option.selected = true;
                        select.appendChild(option);
                    }
                }
            });
            
            // 初始化月份选项
            monthSelectIds.forEach(function(id) {
                var select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '';
                    for (var i = 0; i < monthNames.length; i++) {
                        var option = document.createElement('option');
                        option.value = i + 1;
                        option.text = monthNames[i];
                        if ((id === 'month' || id === 'startMonth') && (i + 1) === currentMonth) option.selected = true;
                        if (id === 'endMonth' && (i + 1) === 12) option.selected = true;
                        select.appendChild(option);
                    }
                }
            });
        }

        // 初始化日历
        function initCalendar() {
            initializeSelectOptions();
            updateCalendar();
            calculateSalary();
        }

        // 获取当前月的日历数据键
        function getCurrentMonthKey() {
            return currentYear + '-' + String(currentMonth).padStart(2, '0');
        }

        // 获取或初始化日历数据
        function getOrCreateCalendarData(year, month) {
            var key = year + '-' + String(month).padStart(2, '0');
            if (!calendarData[key]) {
                calendarData[key] = {};
            }
            return calendarData[key];
        }

        // 更新日历
        function updateCalendar() {
            currentYear = parseInt(document.getElementById('year').value);
            currentMonth = parseInt(document.getElementById('month').value);
            
            document.getElementById('currentMonthYear').textContent = currentYear + '年' + currentMonth + '月';
            
            var calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            var weekdays = ['日', '一', '二', '三', '四', '五', '六'];
            weekdays.forEach(function(day) {
                var headerCell = document.createElement('div');
                headerCell.className = 'calendar-day-header';
                headerCell.textContent = day;
                calendarGrid.appendChild(headerCell);
            });
            
            var firstDay = new Date(currentYear, currentMonth - 1, 1);
            var lastDay = new Date(currentYear, currentMonth, 0);
            var firstDayOfWeek = firstDay.getDay();
            var daysInMonth = lastDay.getDate();
            
            var prevMonthLastDay = new Date(currentYear, currentMonth - 1, 0).getDate();
            for (var i = firstDayOfWeek - 1; i >= 0; i--) {
                var day = prevMonthLastDay - i;
                addDayToCalendar(calendarGrid, currentYear, currentMonth - 1, day, true);
            }
            
            for (var i = 1; i <= daysInMonth; i++) {
                addDayToCalendar(calendarGrid, currentYear, currentMonth, i, false);
            }
            
            var totalCells = 42;
            var remainingCells = totalCells - (firstDayOfWeek + daysInMonth);
            for (var i = 1; i <= remainingCells; i++) {
                addDayToCalendar(calendarGrid, currentYear, currentMonth + 1, i, true);
            }
        }

        // 添加一天到日历
        function addDayToCalendar(grid, year, month, day, isOtherMonth) {
            var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
            var date = new Date(year, month - 1, day);
            var dayOfWeek = date.getDay();
            
            var cell = document.createElement('div');
            cell.className = 'calendar-day';
            if (isOtherMonth) cell.classList.add('other-month');
            if (dayOfWeek === 0 || dayOfWeek === 6) cell.classList.add('weekend');
            
            var monthKey = year + '-' + String(month).padStart(2, '0');
            var monthData = calendarData[monthKey] || {};
            
            if (monthData[dateStr] === 'rest') {
                cell.classList.add('selected-rest');
            } else if (monthData[dateStr] === 'paid') {
                cell.classList.add('selected-paid');
            } else {
                cell.classList.add('working');
            }
            
            var dayNumber = document.createElement('div');
            dayNumber.className = 'calendar-day-number';
            dayNumber.textContent = day;
            cell.appendChild(dayNumber);
            
            if (monthData[dateStr]) {
                var typeIndicator = document.createElement('div');
                typeIndicator.className = 'calendar-day-type ' + 
                    (monthData[dateStr] === 'rest' ? 'rest-indicator' : 
                     monthData[dateStr] === 'paid' ? 'paid-indicator' : 'working-indicator');
                typeIndicator.textContent = monthData[dateStr] === 'rest' ? '休' : 
                                           monthData[dateStr] === 'paid' ? '薪' : '工';
                cell.appendChild(typeIndicator);
            }
            
            cell.addEventListener('click', function() {
                toggleDaySelection(dateStr, cell, year, month);
                debouncedCalculate();
            });
            
            grid.appendChild(cell);
        }

        // 切换日期选择状态
        function toggleDaySelection(dateStr, cell, year, month) {
            var monthKey = year + '-' + String(month).padStart(2, '0');
            var monthData = getOrCreateCalendarData(year, month);
            
            if (monthData[dateStr] === 'rest') {
                monthData[dateStr] = 'paid';
                cell.classList.remove('selected-rest');
                cell.classList.add('selected-paid');
                updateDayIndicator(cell, 'paid');
            } else if (monthData[dateStr] === 'paid') {
                delete monthData[dateStr];
                cell.classList.remove('selected-paid');
                cell.classList.add('working');
                removeDayIndicator(cell);
            } else {
                monthData[dateStr] = 'rest';
                cell.classList.remove('working');
                cell.classList.add('selected-rest');
                updateDayIndicator(cell, 'rest');
            }
        }

        // 更新日期指示器
        function updateDayIndicator(cell, type) {
            var indicators = cell.getElementsByClassName('calendar-day-type');
            if (indicators.length > 0) {
                indicators[0].className = 'calendar-day-type ' + (type === 'rest' ? 'rest-indicator' : 'paid-indicator');
                indicators[0].textContent = type === 'rest' ? '休' : '薪';
            } else {
                var typeIndicator = document.createElement('div');
                typeIndicator.className = 'calendar-day-type ' + (type === 'rest' ? 'rest-indicator' : 'paid-indicator');
                typeIndicator.textContent = type === 'rest' ? '休' : '薪';
                cell.appendChild(typeIndicator);
            }
        }

        // 移除日期指示器
        function removeDayIndicator(cell) {
            var indicators = cell.getElementsByClassName('calendar-day-type');
            if (indicators.length > 0) cell.removeChild(indicators[0]);
        }

        // 切换月份
        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
            
            if (currentYear < 1950) currentYear = 1950;
            if (currentYear > 2050) currentYear = 2050;
            
            document.getElementById('year').value = currentYear;
            document.getElementById('month').value = currentMonth;
            updateCalendar();
            calculateSalary();
        }

        function adjustValue(inputId, increment) {
            var input = document.getElementById(inputId);
            var currentValue = parseFloat(input.value) || 0;
            input.value = Math.max(0, currentValue + increment).toFixed(1);
            calculateSalary();
        }

        function debouncedCalculate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(calculateSalary, 300);
        }

        // 核心计算函数
        function computeSalaryForMonth(year, month, calendarDataForMonth) {
            var hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            var performanceRate = parseFloat(document.getElementById('performanceRate').value) || 0;
            var efficiencyFactor = parseFloat(document.getElementById('efficiencyFactor').value) || 0;
            var weekdayNightFee = parseFloat(document.getElementById('weekdayNightFee').value) || 0;
            var weekendNightFee = parseFloat(document.getElementById('weekendNightFee').value) || 0;
            var paidLeaveRate = parseFloat(document.getElementById('paidLeaveRate').value) || 0;
            var singleTimeLeave = parseFloat(document.getElementById('singleTimeLeave').value) || 0;
            var overtime15Leave = parseFloat(document.getElementById('overtime15Leave').value) || 0;
            var doubleTimeLeave = parseFloat(document.getElementById('doubleTimeLeave').value) || 0;

            var startDate = new Date(year, month - 1, 1);
            var endDate = new Date(year, month, 0);

            // 计算每月各类型日期数量
            var allWeekdays = 0, allSaturdays = 0, allSundays = 0;
            var paidLeaveDays = 0, restDays = 0;
            var weekdayPaidLeaves = 0, saturdayPaidLeaves = 0, sundayPaidLeaves = 0;

            for (var d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                var dayOfWeek = d.getDay();
                var dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                var dayType = calendarDataForMonth[dateStr];

                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    allWeekdays++;
                    if (dayType === 'paid') weekdayPaidLeaves++;
                }
                else if (dayOfWeek === 6) {
                    allSaturdays++;
                    if (dayType === 'paid') saturdayPaidLeaves++;
                }
                else if (dayOfWeek === 0) {
                    allSundays++;
                    if (dayType === 'paid') sundayPaidLeaves++;
                }

                if (dayType === 'paid') paidLeaveDays++;
                else if (dayType === 'rest') restDays++;
            }

            var shouldWorkDays = allWeekdays - weekdayPaidLeaves;
            var shouldWorkHours = shouldWorkDays * 8;

            // 计算实际上班天数
            var actualWeekdayDays = 0, actualSaturdayDays = 0, actualSundayDays = 0;
            for (var d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                var dayOfWeek = d.getDay();
                var dateStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                var dayType = calendarDataForMonth[dateStr];
                if (dayType !== 'rest' && dayType !== 'paid') {
                    if (dayOfWeek >= 1 && dayOfWeek <= 5) actualWeekdayDays++;
                    else if (dayOfWeek === 6) actualSaturdayDays++;
                    else if (dayOfWeek === 0) actualSundayDays++;
                }
            }

            // 计算实际工时
            var actualSingleHours = Math.max(0, actualWeekdayDays * 8 - singleTimeLeave);
            var actualOvertime15 = Math.max(0, actualWeekdayDays * 2 - overtime15Leave);
            var actualSundayHours = Math.max(0, actualSundayDays * 8 - doubleTimeLeave);
            var actualSaturdayHours = actualSaturdayDays * 10;
            var actualTotalHours = actualSingleHours + actualOvertime15 + actualSundayHours + actualSaturdayHours;

            // 计算工作日休息天数和周末上班天数
            var weekdayRestDays = allWeekdays - actualWeekdayDays - weekdayPaidLeaves;
            var weekendWorkDays = actualSaturdayDays + actualSundayDays;

            // 判断情况类型
            var caseType = weekdayRestDays > weekendWorkDays ? '情况一' : '情况二';

            // 计算工资分配（根据情况类型）
            var singlePayHours, overtime15PayHours, doublePayHours;

            if (caseType === '情况一') {
                // 情况一：工作日休息天数 > 周末上班天数
                singlePayHours = Math.max(0, (actualWeekdayDays * 8 + actualSaturdayDays * 8 + actualSundayDays * 8) - singleTimeLeave);
                overtime15PayHours = Math.max(0, (actualWeekdayDays * 2) - overtime15Leave);
                doublePayHours = actualSaturdayDays * 2;
            } else {
                // 情况二：工作日休息天数 <= 周末上班天数
                if (actualTotalHours <= shouldWorkHours) {
                    singlePayHours = actualSingleHours;
                    overtime15PayHours = actualOvertime15;
                    doublePayHours = actualSaturdayHours + actualSundayHours;
                } else {
                    singlePayHours = Math.min(shouldWorkHours, actualTotalHours);
                    var remaining = actualTotalHours - singlePayHours;
                    overtime15PayHours = Math.min(remaining, actualOvertime15);
                    doublePayHours = remaining - overtime15PayHours;
                }
            }

            // 计算各项工资
            var basicSalary = singlePayHours * hourlyRate;
            var overtime15Salary = overtime15PayHours * hourlyRate * 1.5;
            var doubleOvertimeSalary = doublePayHours * hourlyRate * 2;
            var totalOvertimeSalary = overtime15Salary + doubleOvertimeSalary;
            var performanceBonus = actualTotalHours * performanceRate;
            var efficiencyBonus = Math.ceil(efficiencyFactor * actualTotalHours * 25 * 10) / 10;
            var nightShiftFee = (actualWeekdayDays + actualSaturdayDays) * weekdayNightFee + actualSundayDays * weekendNightFee;
            var paidLeaveSalary = paidLeaveDays * paidLeaveRate;
            var totalSalary = basicSalary + totalOvertimeSalary + performanceBonus + efficiencyBonus + nightShiftFee + paidLeaveSalary;

            return {
                year: year,
                month: month,
                basicSalary: basicSalary,
                overtimeSalary: totalOvertimeSalary,
                performanceBonus: performanceBonus,
                efficiencyBonus: efficiencyBonus,
                nightShiftFee: nightShiftFee,
                paidLeaveSalary: paidLeaveSalary,
                totalSalary: totalSalary,
                shouldWorkDays: shouldWorkDays,
                shouldWorkHours: shouldWorkHours,
                actualTotalHours: actualTotalHours,
                actualSingleHours: actualSingleHours,
                actualOvertime15: actualOvertime15,
                actualSundayHours: actualSundayHours,
                actualSaturdayHours: actualSaturdayHours,
                restDays: restDays,
                paidLeaveDays: paidLeaveDays,
                weekdayRestDays: weekdayRestDays,
                weekendWorkDays: weekendWorkDays,
                caseType: caseType,
                singlePayHours: singlePayHours,
                overtime15PayHours: overtime15PayHours,
                doublePayHours: doublePayHours
            };
        }

        function calculateSalary() {
            var year = parseInt(document.getElementById('year').value);
            var month = parseInt(document.getElementById('month').value);
            var monthData = getOrCreateCalendarData(year, month);
            var result = computeSalaryForMonth(year, month, monthData);

            // 更新显示结果
            updateDisplayResults(result);
        }

        // 更新显示结果
        function updateDisplayResults(result) {
            var displayMap = {
                'basicSalary': result.basicSalary.toFixed(2) + '元',
                'overtimeSalary': result.overtimeSalary.toFixed(2) + '元',
                'performanceBonus': result.performanceBonus.toFixed(2) + '元',
                'efficiencyBonus': result.efficiencyBonus.toFixed(2) + '元',
                'nightShiftFee': result.nightShiftFee.toFixed(2) + '元',
                'paidLeaveSalary': result.paidLeaveSalary.toFixed(2) + '元',
                'totalSalary': result.totalSalary.toFixed(2),
                'yearMonth': result.year + '年' + result.month + '月',
                'shouldWorkDays': result.shouldWorkDays,
                'shouldWorkHours': result.shouldWorkHours,
                'actualTotalHours': result.actualTotalHours,
                'actualSingleHours': result.actualSingleHours,
                'actualOvertime15': result.actualOvertime15,
                'actualSundayHours': result.actualSundayHours,
                'actualSaturdayHours': result.actualSaturdayHours,
                'restDaysCount': result.restDays,
                'paidLeaveCount': result.paidLeaveDays,
                'weekdayRestDays': result.weekdayRestDays,
                'weekendWorkDays': result.weekendWorkDays,
                'caseType': result.caseType
            };

            for (var id in displayMap) {
                var element = document.getElementById(id);
                if (element) element.textContent = displayMap[id];
            }

            var hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
            document.getElementById('singlePayAmount').textContent = 
                result.singlePayHours.toFixed(2) + '小时 (' + (result.singlePayHours * hourlyRate).toFixed(2) + '元)';
            document.getElementById('overtime15PayAmount').textContent = 
                result.overtime15PayHours.toFixed(2) + '小时 (' + (result.overtime15PayHours * hourlyRate * 1.5).toFixed(2) + '元)';
            document.getElementById('doublePayAmount').textContent = 
                result.doublePayHours.toFixed(2) + '小时 (' + (result.doublePayHours * hourlyRate * 2).toFixed(2) + '元)';
            document.getElementById('breakdownTotal').textContent = result.totalSalary.toFixed(2) + '元';
        }

        // 批量计算函数
        function calculateMultipleMonths() {
            var startYear = parseInt(document.getElementById('startYear').value);
            var startMonth = parseInt(document.getElementById('startMonth').value);
            var endYear = parseInt(document.getElementById('endYear').value);
            var endMonth = parseInt(document.getElementById('endMonth').value);

            var months = [];
            var y = startYear, m = startMonth;
            while (y < endYear || (y === endYear && m <= endMonth)) {
                months.push({ year: y, month: m });
                m++;
                if (m > 12) { m = 1; y++; }
            }

            var tbody = document.getElementById('batchTableBody');
            tbody.innerHTML = '';

            months.forEach(function(item) {
                var monthData = getOrCreateCalendarData(item.year, item.month);
                var res = computeSalaryForMonth(item.year, item.month, monthData);

                var row = tbody.insertRow();
                row.innerHTML = `
                    <td>${res.year}年${res.month}月</td>
                    <td>${res.basicSalary.toFixed(2)}</td>
                    <td>${res.overtimeSalary.toFixed(2)}</td>
                    <td>${res.performanceBonus.toFixed(2)}</td>
                    <td>${res.efficiencyBonus.toFixed(2)}</td>
                    <td>${res.nightShiftFee.toFixed(2)}</td>
                    <td>${res.paidLeaveSalary.toFixed(2)}</td>
                    <td><strong>${res.totalSalary.toFixed(2)}</strong></td>
                `;
            });

            document.getElementById('batchResults').style.display = 'block';
        }

        function exportBatchToCSV() {
            var table = document.getElementById('batchTable');
            var rows = [];
            for (var i = 0; i < table.rows.length; i++) {
                var row = [], cols = table.rows[i].cells;
                for (var j = 0; j < cols.length; j++) {
                    var data = cols[j].innerText.replace(/"/g, '""');
                    row.push('"' + data + '"');
                }
                rows.push(row.join(','));
            }
            var csv = rows.join('\n');
            var csvContent = '\uFEFF' + csv;
            var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = '多月工资汇总.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showTab(tabName) {
            var contents = document.querySelectorAll('.tab-content');
            var tabs = document.querySelectorAll('.tab');
            
            contents.forEach(c => c.classList.remove('active'));
            tabs.forEach(t => t.classList.remove('active'));
            
            var targetContent = document.getElementById(tabName);
            if (targetContent) targetContent.classList.add('active');
            if (event && event.target) event.target.classList.add('active');
        }
        
        // 折叠面板功能
        var coll = document.getElementsByClassName("collapsible");
        for (var i = 0; i < coll.length; i++) {
            coll[i].addEventListener("click", function() {
                this.classList.toggle("active");
                var content = this.nextElementSibling;
                if (content) content.classList.toggle("show");
            });
        }
        
        // 工作状态导入导出
        function exportWorkStatus() {
            var dataStr = JSON.stringify(calendarData, null, 2);
            var dataBlob = new Blob([dataStr], { type: 'application/json;charset=utf-8' });
            var url = URL.createObjectURL(dataBlob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'work_status_' + getCurrentMonthKey().replace('-', '_') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importWorkStatus(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var importedData = JSON.parse(e.target.result);
                    for (var key in importedData) {
                        if (importedData.hasOwnProperty(key)) {
                            calendarData[key] = importedData[key];
                        }
                    }
                    
                    // 显示自动关闭的通知
                    showNotification();
                    
                    updateCalendar();
                    calculateSalary();
                } catch (err) {
                    alert('导入失败：文件格式不正确。\n请确保是有效的 JSON 文件。');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        // 显示自动关闭通知
        function showNotification() {
            const notification = document.getElementById('notification');
            
            // 重置动画
            notification.classList.remove('show');
            
            // 强制重排以重新启动动画
            void notification.offsetWidth;
            
            // 显示通知
            notification.classList.add('show');
            
            // 3秒后自动隐藏通知
            setTimeout(function() {
                notification.classList.remove('show');
            }, 3000);
        }
        
        window.onload = function() {
            initCalendar();
        };
    </script>
</body>
</html>
